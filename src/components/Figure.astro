---
interface Props {
  src: string;
  alt: string;
  caption: string;
  class?: string;
  width?: number;
  height?: number;
  darkmode?: boolean;
}

const { src, alt, class: className, width, height, darkmode = true } = Astro.props;

// Generate dark variant path by inserting '_dark' before the file extension
const getPathWithoutExtension = (path: string) => {
  const lastDot = path.lastIndexOf('.');
  return lastDot === -1 ? path : path.substring(0, lastDot);
};

const getExtension = (path: string) => {
  const lastDot = path.lastIndexOf('.');
  return lastDot === -1 ? '' : path.substring(lastDot);
};

const darkSrc = darkmode ? `${getPathWithoutExtension(src)}_dark${getExtension(src)}` : src;
const imageId = `themed-image-${Math.random().toString(36).substr(2, 9)}`;

// Check if the source is a video file
const videoExtensions = ['.mp4', '.webm', '.ogg'];
const isVideo = videoExtensions.some(ext => src.toLowerCase().endsWith(ext));
---

<div class="flex justify-center">
  {isVideo ? (
    <video 
    id={imageId}
    class={`${className} py-0`}
    width={width}
    height={height}
    data-light-src={src}
    data-dark-src={darkSrc}
    autoplay
    muted
    playsinline
    controls
    >
    <source src={src} type={`video/${getExtension(src).substring(1)}`} />
    {alt}
  </video>
) : (
  <img 
  id={imageId}
  src={src} 
  alt={alt} 
  class={`${className} py-0`}
  width={width}
  height={height}
  data-light-src={src}
  data-dark-src={darkSrc}
  />
)}
</div>
<p class="caption text-sm mt-0 px-10 text-center italic text-gray-600 dark:text-gray-400">{Astro.props.alt}</p>

<script define:vars={{ imageId, src, darkSrc }}>
  function updateMedia() {
    const media = document.getElementById(imageId);
    if (!media) return;
    
    const isDark = document.documentElement.classList.contains('dark');
    const newSrc = isDark ? darkSrc : src;
    
    if (media.tagName === 'VIDEO') {
      const source = media.querySelector('source');
      if (source && source.src !== newSrc) {
        source.src = newSrc;
        media.load();
      }
    } else {
      media.src = newSrc;
    }
  }

  // Update on initial load
  updateMedia();

  // Create a MutationObserver to watch for theme changes
  const observer = new MutationObserver((mutations) => {
    mutations.forEach((mutation) => {
      if (mutation.attributeName === 'class') {
        updateMedia();
      }
    });
  });

  observer.observe(document.documentElement, {
    attributes: true,
    attributeFilter: ['class']
  });

  // Also update after Astro page transitions
  document.addEventListener('astro:after-swap', updateMedia);
</script>

